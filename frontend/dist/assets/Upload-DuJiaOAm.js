import{_ as J,a as x,r as W,l as T,c as X,b as N,d as t,i as V,y as E,w as l,e as m,j as k,u as b,K as D,f as y,g as Y,h as Z,t as P,L as ee,M as te,I as ae,N as le,E as i,O as oe,k as $}from"./index-D-xSYIE6.js";import{a as z}from"./index-B9ygI19o.js";const se={class:"upload-container"},ne={class:"card-header"},ie={class:"card-title"},re={class:"file-stats"},ue={__name:"Upload",setup(ce){const F=oe(),h=x(null),B=x(!1),p=x([]),c=x([]),w=x(null),s=W({taskName:"",sourcePath:"",targetPath:"",recursive:!0}),U=T(()=>p.value.reduce((o,e)=>o+e.fileSize,0)),M=T(()=>c.value.reduce((o,e)=>o+e.fileSize,0)),A=async()=>{var o,e;if(!s.sourcePath){i.warning("请输入源路径");return}B.value=!0,p.value=[],c.value=[];try{const{data:a}=await z.post("/api/file/scan",{directoryPath:s.sourcePath,recursive:s.recursive,limit:1e3});if(a.code===200){const n=a.data;if(p.value=n.files,w.value=n,n.hasMore?i.warning({message:n.message,duration:5e3,showClose:!0}):i.success(`扫描完成，共找到 ${n.totalCount} 个文件`),!s.taskName){const u=new Date().toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(/\//g,"-");s.taskName=`上传任务_${u}`}}else i.error(a.message||"扫描失败")}catch(a){i.error("扫描目录失败: "+(((e=(o=a.response)==null?void 0:o.data)==null?void 0:e.message)||a.message))}finally{B.value=!1}},L=o=>{c.value=o},I=()=>{c.value=[...p.value],h.value&&p.value.forEach(o=>{h.value.toggleRowSelection(o,!0)})},R=()=>{c.value=[],h.value&&h.value.clearSelection()},Q=async()=>{var o,e;try{const{data:a}=await z.get("/api/account/list");if(a.code!==200){i.error("获取账号信息失败");return}const n=a.data;if(!n||n.length===0){i.warning("没有可用的账号");return}let u=0;if(n.forEach(r=>{const _=r.dailyLimit-r.usedQuota;r.status===1&&_>0&&(u+=_)}),u<=0){i.warning("所有账号配额已用完");return}const f=[...p.value].sort((r,_)=>r.fileSize-_.fileSize),v=[];let d=0;for(const r of f)d+r.fileSize<=u&&(v.push(r),d+=r.fileSize);if(v.length===0){i.warning("没有文件可以在当前配额内上传");return}c.value=v,h.value&&(h.value.clearSelection(),v.forEach(r=>{h.value.toggleRowSelection(r,!0)})),i.success({message:`智能选择完成：已选择 ${v.length} 个文件，总大小 ${S(d)}，剩余配额 ${S(u-d)}`,duration:5e3,showClose:!0})}catch(a){i.error("智能选择失败: "+(((e=(o=a.response)==null?void 0:o.data)==null?void 0:e.message)||a.message))}},G=async()=>{var o,e;if(!s.taskName){i.warning("请输入任务名称");return}if(!s.targetPath){i.warning("请输入目标路径");return}if(c.value.length===0){i.warning("请至少选择一个文件");return}try{let a=!1;if(w.value&&w.value.hasMore)try{await $.confirm(`检测到目录中共有 ${w.value.totalCount} 个文件，但仅显示了前 ${w.value.limit} 个。

您当前选择了 ${c.value.length} 个文件。

是否要上传目录中的全部 ${w.value.totalCount} 个文件？

点击"全部上传"将上传所有文件，点击"仅上传已选"将只上传您选择的文件。`,"文件数量提示",{confirmButtonText:"全部上传",cancelButtonText:"仅上传已选",type:"warning",distinguishCancelAndClose:!0}),a=!0}catch(d){if(d==="close")return;a=!1}const n=a?w.value.totalCount:c.value.length,u=a?w.value.totalSize:M.value;await $.confirm(`确定创建上传任务吗？将上传 ${n} 个文件，总大小 ${S(u)}`,"确认创建",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"});const f={taskName:s.taskName,sourcePath:s.sourcePath,targetPath:s.targetPath};a?(f.uploadAll=!0,f.recursive=s.recursive):f.fileList=c.value.map(d=>d.filePath);const{data:v}=await z.post("/api/task",f);if(v.code===200){const d=v.data;a||await z.post("/api/file/batch-save",{taskId:d,fileList:c.value}),i.success("任务创建成功");try{await $.confirm("是否立即启动该任务？","提示",{confirmButtonText:"立即启动",cancelButtonText:"稍后启动",type:"info"}),await z.put(`/api/task/${d}/start`),i.success("任务已启动")}catch{}F.push("/task")}else i.error(v.message||"创建任务失败")}catch(a){a!=="cancel"&&i.error("创建任务失败: "+(((e=(o=a.response)==null?void 0:o.data)==null?void 0:e.message)||a.message))}},K=o=>{const e=o.split(".").pop();return e?e.toUpperCase():"FILE"},S=o=>{if(!o||o===0)return"0 B";const e=1024,a=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(o)/Math.log(e));return(o/Math.pow(e,n)).toFixed(2)+" "+a[n]};return(o,e)=>{const a=m("el-input"),n=m("el-form-item"),u=m("el-icon"),f=m("el-button"),v=m("el-switch"),d=m("el-form"),r=m("el-card"),_=m("el-statistic"),C=m("el-table-column"),j=m("el-tag"),O=m("el-table"),q=m("el-empty"),H=Z("loading");return N(),X("div",se,[t(r,{class:"create-card"},{header:l(()=>[...e[4]||(e[4]=[y("div",{class:"card-header"},[y("span",{class:"card-title"},"创建上传任务")],-1)])]),default:l(()=>[t(d,{model:s,"label-width":"120px"},{default:l(()=>[t(n,{label:"任务名称"},{default:l(()=>[t(a,{modelValue:s.taskName,"onUpdate:modelValue":e[0]||(e[0]=g=>s.taskName=g),placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1}),t(n,{label:"源路径"},{default:l(()=>[t(a,{modelValue:s.sourcePath,"onUpdate:modelValue":e[1]||(e[1]=g=>s.sourcePath=g),placeholder:"请输入服务器上的文件路径，如 /data/files"},{append:l(()=>[t(f,{onClick:A},{default:l(()=>[t(u,null,{default:l(()=>[t(b(D))]),_:1}),e[5]||(e[5]=k(" 扫描目录 ",-1))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(n,{label:"目标路径"},{default:l(()=>[t(a,{modelValue:s.targetPath,"onUpdate:modelValue":e[2]||(e[2]=g=>s.targetPath=g),placeholder:"请输入Google Drive目标路径，如 /backup"},null,8,["modelValue"])]),_:1}),t(n,{label:"递归扫描"},{default:l(()=>[t(v,{modelValue:s.recursive,"onUpdate:modelValue":e[3]||(e[3]=g=>s.recursive=g)},null,8,["modelValue"]),e[6]||(e[6]=y("span",{style:{"margin-left":"10px",color:"rgba(255, 255, 255, 0.6)","font-size":"12px"}}," 开启后将扫描子目录中的所有文件 ",-1))]),_:1})]),_:1},8,["model"])]),_:1}),p.value.length>0?(N(),V(r,{key:0,class:"file-list-card"},{header:l(()=>[y("div",ne,[y("span",ie," 已扫描文件 ("+P(c.value.length)+" / "+P(p.value.length)+") ",1),y("div",null,[t(f,{type:"warning",onClick:Q},{default:l(()=>[t(u,null,{default:l(()=>[t(b(ee))]),_:1}),e[7]||(e[7]=k(" 智能选择 ",-1))]),_:1}),t(f,{type:"primary",onClick:I},{default:l(()=>[t(u,null,{default:l(()=>[t(b(te))]),_:1}),e[8]||(e[8]=k(" 全选 ",-1))]),_:1}),t(f,{onClick:R},{default:l(()=>[t(u,null,{default:l(()=>[t(b(ae))]),_:1}),e[9]||(e[9]=k(" 取消全选 ",-1))]),_:1}),t(f,{type:"success",disabled:c.value.length===0,onClick:G},{default:l(()=>[t(u,null,{default:l(()=>[t(b(le))]),_:1}),e[10]||(e[10]=k(" 创建任务 ",-1))]),_:1},8,["disabled"])])])]),default:l(()=>[y("div",re,[t(_,{title:"文件总数",value:p.value.length},null,8,["value"]),t(_,{title:"已选文件",value:c.value.length},null,8,["value"]),t(_,{title:"总大小",value:S(U.value)},null,8,["value"]),t(_,{title:"已选大小",value:S(M.value)},null,8,["value"])]),Y((N(),V(O,{ref_key:"fileTableRef",ref:h,data:p.value,style:{width:"100%","margin-top":"16px"},"max-height":"500",onSelectionChange:L},{default:l(()=>[t(C,{type:"selection",width:"55"}),t(C,{prop:"fileName",label:"文件名","min-width":"200","show-overflow-tooltip":""}),t(C,{prop:"filePath",label:"文件路径","min-width":"300","show-overflow-tooltip":""}),t(C,{label:"文件大小",width:"120"},{default:l(({row:g})=>[k(P(S(g.fileSize)),1)]),_:1}),t(C,{label:"文件类型",width:"120"},{default:l(({row:g})=>[t(j,null,{default:l(()=>[k(P(K(g.fileName)),1)]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[H,B.value]])]),_:1})):E("",!0),p.value.length===0&&!B.value?(N(),V(r,{key:1,class:"empty-card"},{default:l(()=>[t(q,{description:"请输入源路径并点击扫描目录按钮"},{image:l(()=>[t(u,{size:100,style:{color:"#86868b"}},{default:l(()=>[t(b(D))]),_:1})]),_:1})]),_:1})):E("",!0)])}}},me=J(ue,[["__scopeId","data-v-cc130379"]]);export{me as default};
