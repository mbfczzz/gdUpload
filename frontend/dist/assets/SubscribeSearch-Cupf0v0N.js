import{_ as Ee,a as u,P as Oe,o as ze,E as d,c as M,b as _,d as e,w as a,y as S,i as C,e as o,Q as Je,j as n,f as p,t as f,g as le,h as Ae,k as K}from"./index-D-xSYIE6.js";import{s as Ue}from"./subscribe-zOCTvdSk.js";import{r as T}from"./request-BSyjQB9W.js";import"./index-B9ygI19o.js";function Me(m){return T({url:"/subscribe-batch/create",method:"post",data:m})}function se(m){return T({url:`/subscribe-batch/start/${m}`,method:"post"})}function Pe(m){return T({url:`/subscribe-batch/pause/${m}`,method:"post"})}function Be(m){return T({url:"/subscribe-batch/page",method:"get",params:m})}function $e(m){return T({url:`/subscribe-batch/${m}/logs`,method:"get"})}function Fe(m){return T({url:`/subscribe-batch/${m}`,method:"delete"})}const je={class:"subscribe-search-container"},Ge={key:0,class:"result-container"},Re={class:"json-result"},Ye={class:"card-header"},Ke={key:0,class:"batch-config"},qe={key:0},Qe={class:"json-result"},He={class:"json-result"},We={style:{"font-size":"12px"}},Xe={__name:"SubscribeSearch",setup(m){const E={JSON_DATA:"subscribe_search_json_data",DELAY_CONFIG:"subscribe_search_delay_config"},V=u(""),b=u(null),I=u(!1),O=u(!1),c=u([]),w=u(1),N=u(2),q=u(!1),g=u(null),P=u(!1),Q=u([]),B=u(!1),h=u({current:1,size:10,total:0}),$=u(!1),H=u([]),F=u(!1),oe=()=>{try{const l=localStorage.getItem(E.JSON_DATA);l&&(c.value=JSON.parse(l));const t=localStorage.getItem(E.DELAY_CONFIG);if(t){const v=JSON.parse(t);w.value=v.min,N.value=v.max}}catch(l){console.error("从 localStorage 加载数据失败:",l)}},j=()=>{try{localStorage.setItem(E.JSON_DATA,JSON.stringify(c.value)),localStorage.setItem(E.DELAY_CONFIG,JSON.stringify({min:w.value,max:N.value}))}catch(l){console.error("保存到 localStorage 失败:",l)}};Oe([c,w,N],()=>{j()},{deep:!0}),ze(()=>{oe(),c.value.length>0&&d.success(`已恢复 ${c.value.length} 个订阅数据`)});const W=async()=>{if(!V.value){d.warning("请输入订阅ID");return}I.value=!0,O.value=!0,b.value=null;try{const l=await Ue(V.value);b.value=l,d.success("搜索成功")}catch(l){console.error("搜索失败:",l),b.value=null}finally{I.value=!1}},ne=()=>{V.value="",b.value=null,O.value=!1},re=l=>{const t=new FileReader;t.onload=v=>{try{const r=JSON.parse(v.target.result);if(!Array.isArray(r)){d.error("JSON格式错误：必须是数组格式");return}const z=r.filter(k=>!k.id);if(z.length>0){d.error(`JSON格式错误：有${z.length}个订阅缺少id字段`);return}c.value=r,d.success(`成功导入${r.length}个订阅`),j()}catch(r){console.error("JSON解析失败:",r),d.error("JSON文件解析失败，请检查文件格式")}},t.readAsText(l.raw)},ue=async()=>{if(c.value.length===0){d.warning("请先导入JSON文件");return}try{await K.confirm(`即将创建后台批量任务，包含 ${c.value.length} 个订阅，每次请求间隔 ${w.value}-${N.value} 分钟。任务将在后台执行，即使关闭浏览器也会继续运行。是否继续？`,"确认创建后台任务",{confirmButtonText:"创建并启动",cancelButtonText:"取消",type:"warning"})}catch{return}try{const l=`订阅搜索任务-${new Date().toLocaleString("zh-CN")}`,v=(await Me({taskName:l,jsonData:JSON.stringify(c.value),delayMin:w.value,delayMax:N.value})).data;await se(v),d.success("后台任务已创建并启动，可以关闭浏览器了"),X()}catch(l){console.error("创建后台任务失败:",l)}},X=async()=>{P.value=!0,await D()},D=async()=>{B.value=!0;try{const l=await Be({current:h.value.current,size:h.value.size});Q.value=l.data.records,h.value.total=l.data.total}catch(l){console.error("加载任务列表失败:",l)}finally{B.value=!1}},ie=async l=>{try{await se(l),d.success("任务已启动"),await D()}catch(t){console.error("启动任务失败:",t)}},ce=async l=>{try{await Pe(l),d.success("任务已暂停"),await D()}catch(t){console.error("暂停任务失败:",t)}},de=async l=>{$.value=!0,F.value=!0;try{const t=await $e(l);H.value=t.data}catch(t){console.error("加载任务日志失败:",t)}finally{F.value=!1}},pe=async l=>{try{await K.confirm("确定要删除这个任务吗？","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Fe(l),d.success("任务已删除"),await D()}catch(t){t!=="cancel"&&console.error("删除任务失败:",t)}},fe=l=>({PENDING:"info",RUNNING:"success",PAUSED:"warning",COMPLETED:"success",FAILED:"danger"})[l]||"info",me=l=>({PENDING:"待执行",RUNNING:"执行中",PAUSED:"已暂停",COMPLETED:"已完成",FAILED:"失败"})[l]||l,_e=async()=>{try{await K.confirm("确定要清空所有数据吗？这将删除导入的订阅配置。","确认清空",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})}catch{return}c.value=[],j(),d.success("数据已清空")},G=l=>JSON.stringify(l,null,2),ge=l=>new Date(l).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});return(l,t)=>{const v=o("Search"),r=o("el-icon"),z=o("el-input"),k=o("el-col"),y=o("el-button"),J=o("el-row"),ve=o("InfoFilled"),A=o("el-divider"),L=o("el-card"),Z=o("el-empty"),ye=o("Loading"),U=o("el-tag"),be=o("UploadFilled"),he=o("el-upload"),ke=o("Setting"),Se=o("Document"),we=o("el-statistic"),ee=o("el-input-number"),Ne=o("el-form-item"),Ce=o("el-form"),De=o("VideoPlay"),xe=o("List"),Te=o("Delete"),x=o("el-descriptions-item"),Ve=o("el-descriptions"),R=o("el-dialog"),i=o("el-table-column"),Ie=o("el-progress"),te=o("el-table"),Le=o("el-pagination"),ae=Ae("loading");return _(),M("div",je,[e(L,{class:"search-card"},{header:a(()=>[...t[8]||(t[8]=[p("div",{class:"card-header"},[p("span",null,"单个订阅搜索")],-1)])]),default:a(()=>[e(J,{gutter:16,class:"search-bar"},{default:a(()=>[e(k,{span:8},{default:a(()=>[e(z,{modelValue:V.value,"onUpdate:modelValue":t[0]||(t[0]=s=>V.value=s),placeholder:"请输入订阅ID",clearable:"",onKeyup:Je(W,["enter"])},{prefix:a(()=>[e(r,null,{default:a(()=>[e(v)]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(k,{span:16},{default:a(()=>[e(y,{type:"primary",onClick:W,loading:I.value},{default:a(()=>[e(r,null,{default:a(()=>[e(v)]),_:1}),t[9]||(t[9]=n(" 搜索订阅 ",-1))]),_:1},8,["loading"]),e(y,{onClick:ne},{default:a(()=>[...t[10]||(t[10]=[n("重置",-1)])]),_:1})]),_:1})]),_:1}),b.value?(_(),M("div",Ge,[e(A,{"content-position":"left"},{default:a(()=>[e(r,null,{default:a(()=>[e(ve)]),_:1}),t[11]||(t[11]=n(" 订阅信息 ",-1))]),_:1}),e(L,{class:"result-card",shadow:"never"},{default:a(()=>[p("pre",Re,f(G(b.value)),1)]),_:1})])):S("",!0),!b.value&&!I.value&&O.value?(_(),C(Z,{key:1,description:"未找到订阅信息","image-size":200})):S("",!0),!b.value&&!I.value&&!O.value?(_(),C(Z,{key:2,description:"请输入订阅ID进行搜索","image-size":200},{image:a(()=>[e(r,{size:100,color:"#909399"},{default:a(()=>[e(v)]),_:1})]),_:1})):S("",!0)]),_:1}),e(L,{class:"batch-card"},{header:a(()=>[p("div",Ye,[t[13]||(t[13]=p("span",null,"批量订阅搜索",-1)),l.batchRunning?(_(),C(U,{key:0,type:"success",effect:"dark"},{default:a(()=>[e(r,{class:"is-loading"},{default:a(()=>[e(ye)]),_:1}),t[12]||(t[12]=n(" 执行中 ",-1))]),_:1})):S("",!0)])]),default:a(()=>[e(J,{gutter:16},{default:a(()=>[e(k,{span:24},{default:a(()=>[e(he,{class:"upload-demo",drag:"","auto-upload":!1,"on-change":re,"show-file-list":!1,accept:".json"},{tip:a(()=>[...t[14]||(t[14]=[p("div",{class:"el-upload__tip"}," 支持包含订阅列表的JSON文件，每个订阅需包含id字段 ",-1)])]),default:a(()=>[e(r,{class:"el-icon--upload"},{default:a(()=>[e(be)]),_:1}),t[15]||(t[15]=p("div",{class:"el-upload__text"},[n(" 拖拽JSON文件到此处或 "),p("em",null,"点击上传")],-1))]),_:1})]),_:1})]),_:1}),c.value.length>0?(_(),M("div",Ke,[e(A,{"content-position":"left"},{default:a(()=>[e(r,null,{default:a(()=>[e(ke)]),_:1}),t[16]||(t[16]=n(" 批量配置 ",-1))]),_:1}),e(J,{gutter:16,class:"config-row"},{default:a(()=>[e(k,{span:12},{default:a(()=>[e(we,{title:"订阅总数",value:c.value.length},{prefix:a(()=>[e(r,null,{default:a(()=>[e(Se)]),_:1})]),_:1},8,["value"])]),_:1}),e(k,{span:12},{default:a(()=>[e(Ce,{"label-width":"120px"},{default:a(()=>[e(Ne,{label:"请求间隔"},{default:a(()=>[e(ee,{modelValue:w.value,"onUpdate:modelValue":t[1]||(t[1]=s=>w.value=s),min:1,max:10},null,8,["modelValue"]),t[17]||(t[17]=p("span",{style:{margin:"0 8px"}},"-",-1)),e(ee,{modelValue:N.value,"onUpdate:modelValue":t[2]||(t[2]=s=>N.value=s),min:1,max:10},null,8,["modelValue"]),t[18]||(t[18]=p("span",{style:{"margin-left":"8px"}},"分钟",-1))]),_:1})]),_:1})]),_:1})]),_:1}),e(J,{gutter:16,style:{"margin-top":"16px"}},{default:a(()=>[e(k,{span:24},{default:a(()=>[e(y,{type:"primary",onClick:ue,disabled:c.value.length===0},{default:a(()=>[e(r,null,{default:a(()=>[e(De)]),_:1}),t[19]||(t[19]=n(" 后台批量搜索（关闭浏览器继续执行） ",-1))]),_:1},8,["disabled"]),e(y,{type:"success",onClick:X},{default:a(()=>[e(r,null,{default:a(()=>[e(xe)]),_:1}),t[20]||(t[20]=n(" 查看任务列表 ",-1))]),_:1}),e(y,{onClick:_e},{default:a(()=>[e(r,null,{default:a(()=>[e(Te)]),_:1}),t[21]||(t[21]=n(" 清空数据 ",-1))]),_:1})]),_:1})]),_:1})])):S("",!0)]),_:1}),e(R,{modelValue:q.value,"onUpdate:modelValue":t[3]||(t[3]=s=>q.value=s),title:"请求详情",width:"70%","close-on-click-modal":!1},{default:a(()=>[g.value?(_(),M("div",qe,[e(Ve,{column:2,border:""},{default:a(()=>[e(x,{label:"订阅ID"},{default:a(()=>[n(f(g.value.id),1)]),_:1}),e(x,{label:"订阅名称"},{default:a(()=>[n(f(g.value.name),1)]),_:1}),e(x,{label:"状态"},{default:a(()=>[e(U,{type:g.value.status==="success"?"success":"danger"},{default:a(()=>[n(f(g.value.status==="success"?"成功":"失败"),1)]),_:1},8,["type"])]),_:1}),e(x,{label:"时间"},{default:a(()=>[n(f(ge(g.value.timestamp)),1)]),_:1}),e(x,{label:"延迟"},{default:a(()=>[n(f(g.value.delay)+"秒",1)]),_:1}),e(x,{label:"消息"},{default:a(()=>[n(f(g.value.message),1)]),_:1})]),_:1}),e(A,{"content-position":"left"},{default:a(()=>[...t[22]||(t[22]=[n("请求信息",-1)])]),_:1}),e(L,{class:"result-card",shadow:"never"},{default:a(()=>[p("pre",Qe,f(G(g.value.request)),1)]),_:1}),e(A,{"content-position":"left"},{default:a(()=>[...t[23]||(t[23]=[n("响应信息",-1)])]),_:1}),e(L,{class:"result-card",shadow:"never"},{default:a(()=>[p("pre",He,f(G(g.value.response)),1)]),_:1})])):S("",!0)]),_:1},8,["modelValue"]),e(R,{modelValue:P.value,"onUpdate:modelValue":t[6]||(t[6]=s=>P.value=s),title:"后台任务列表",width:"90%","close-on-click-modal":!1},{default:a(()=>[le((_(),C(te,{data:Q.value,style:{width:"100%"}},{default:a(()=>[e(i,{prop:"id",label:"任务ID",width:"80"}),e(i,{prop:"taskName",label:"任务名称",width:"200"}),e(i,{prop:"status",label:"状态",width:"100"},{default:a(({row:s})=>[e(U,{type:fe(s.status),size:"small"},{default:a(()=>[n(f(me(s.status)),1)]),_:2},1032,["type"])]),_:1}),e(i,{label:"进度",width:"200"},{default:a(({row:s})=>[e(Ie,{percentage:Math.round(s.completedCount/s.totalCount*100),status:s.status==="COMPLETED"?"success":"info"},{default:a(()=>[p("span",We,f(s.completedCount)+"/"+f(s.totalCount),1)]),_:2},1032,["percentage","status"])]),_:1}),e(i,{prop:"successCount",label:"成功",width:"80"}),e(i,{prop:"failedCount",label:"失败",width:"80"}),e(i,{prop:"createTime",label:"创建时间",width:"180"}),e(i,{label:"操作",width:"250",fixed:"right"},{default:a(({row:s})=>[s.status==="PENDING"||s.status==="PAUSED"?(_(),C(y,{key:0,link:"",type:"primary",size:"small",onClick:Y=>ie(s.id)},{default:a(()=>[...t[24]||(t[24]=[n(" 启动 ",-1)])]),_:1},8,["onClick"])):S("",!0),s.status==="RUNNING"?(_(),C(y,{key:1,link:"",type:"warning",size:"small",onClick:Y=>ce(s.id)},{default:a(()=>[...t[25]||(t[25]=[n(" 暂停 ",-1)])]),_:1},8,["onClick"])):S("",!0),e(y,{link:"",type:"primary",size:"small",onClick:Y=>de(s.id)},{default:a(()=>[...t[26]||(t[26]=[n(" 查看日志 ",-1)])]),_:1},8,["onClick"]),e(y,{link:"",type:"danger",size:"small",onClick:Y=>pe(s.id)},{default:a(()=>[...t[27]||(t[27]=[n(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ae,B.value]]),e(Le,{"current-page":h.value.current,"onUpdate:currentPage":t[4]||(t[4]=s=>h.value.current=s),"page-size":h.value.size,"onUpdate:pageSize":t[5]||(t[5]=s=>h.value.size=s),total:h.value.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:D,onSizeChange:D,style:{"margin-top":"16px","justify-content":"center"}},null,8,["current-page","page-size","total"])]),_:1},8,["modelValue"]),e(R,{modelValue:$.value,"onUpdate:modelValue":t[7]||(t[7]=s=>$.value=s),title:"任务执行日志",width:"90%","close-on-click-modal":!1},{default:a(()=>[le((_(),C(te,{data:H.value,style:{width:"100%"},"max-height":"500"},{default:a(()=>[e(i,{type:"index",label:"#",width:"60"}),e(i,{prop:"subscribeId",label:"订阅ID",width:"100"}),e(i,{prop:"subscribeName",label:"订阅名称",width:"150"}),e(i,{prop:"status",label:"状态",width:"100"},{default:a(({row:s})=>[e(U,{type:s.status==="SUCCESS"?"success":"danger",size:"small"},{default:a(()=>[n(f(s.status==="SUCCESS"?"成功":"失败"),1)]),_:2},1032,["type"])]),_:1}),e(i,{prop:"delaySeconds",label:"延迟(秒)",width:"100"}),e(i,{prop:"executeTime",label:"执行时间",width:"180"}),e(i,{prop:"errorMessage",label:"错误信息","min-width":"200","show-overflow-tooltip":""})]),_:1},8,["data"])),[[ae,F.value]])]),_:1},8,["modelValue"])])}}},lt=Ee(Xe,[["__scopeId","data-v-cc213bee"]]);export{lt as default};
