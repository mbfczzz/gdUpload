# 115 资源智能搜索算法说明

## 搜索策略

采用**评分匹配算法**，对数据库中的每个资源计算匹配分数，返回分数最高的资源。

## 评分规则

### 1. 完全匹配 (+1000分)
搜索词与资源名称完全相同

**示例**：
- 搜索：`韫色过浓 (2020)`
- 资源：`韫色过浓 (2020)`
- 结果：✅ 完全匹配，+1000分

### 2. 包含匹配 (+500分)
资源名称包含搜索词

**示例**：
- 搜索：`韫色过浓`
- 资源：`韫色过浓 (2020)`
- 结果：✅ 包含匹配，+500分

### 3. 简化匹配 (+300分)
去除特殊字符、空格后匹配

**示例**：
- 搜索：`韫 色 过 浓`（带空格）
- 资源：`韫色过浓 (2020)`
- 简化后：`韫色过浓` vs `韫色过浓2020`
- 结果：✅ 简化匹配，+300分

### 4. 关键词匹配 (+100分/词)
提取关键词后匹配（2-10个字符的词）

**示例**：
- 搜索：`韫色过浓电视剧`
- 资源：`韫色过浓 (2020)`
- 关键词：`韫色过浓`、`韫色过`、`色过浓` 等
- 结果：✅ 多个关键词匹配，+300分

### 5. 年份匹配 (+200分)
资源名称包含指定年份

**示例**：
- 搜索：`韫色过浓` + 年份 `2020`
- 资源：`韫色过浓 (2020)`
- 结果：✅ 年份匹配，+200分

### 6. 分词匹配 (+50分/词)
搜索词分词后逐个匹配（至少2个字符）

**示例**：
- 搜索：`韫色 过浓`
- 资源：`韫色过浓 (2020)`
- 分词：`韫色`、`过浓`
- 结果：✅ 两个词都匹配，+100分

## 搜索流程

```
输入: name, originalTitle, year
    ↓
构建搜索词列表
    ├─ name
    ├─ name (去除年份)
    ├─ originalTitle
    └─ originalTitle (去除年份)
    ↓
获取数据库所有资源
    ↓
对每个资源计算匹配分数
    ├─ 完全匹配？ +1000
    ├─ 包含匹配？ +500
    ├─ 简化匹配？ +300
    ├─ 关键词匹配？ +100/词
    ├─ 年份匹配？ +200
    └─ 分词匹配？ +50/词
    ↓
返回分数最高的资源
```

## 匹配示例

### 示例1：精确匹配

**Emby媒体项**：
- name: `韫色过浓`
- year: `2020`

**数据库资源**：
- `韫色过浓 (2020)` - 国产剧

**匹配过程**：
1. 搜索词：`韫色过浓`、`韫色过浓`（去年份后相同）
2. 包含匹配：`韫色过浓 (2020)` contains `韫色过浓` → +500
3. 简化匹配：`韫色过浓2020` contains `韫色过浓` → +300
4. 关键词匹配：`韫色过浓` → +100
5. 年份匹配：包含 `2020` → +200
6. **总分：1100分** ✅

### 示例2：模糊匹配

**Emby媒体项**：
- name: `天衣无缝`
- originalTitle: `Perfect Partner`
- year: `2019`

**数据库资源**：
- `天衣无缝 (2019)` - 国产剧

**匹配过程**：
1. 搜索词：`天衣无缝`、`Perfect Partner`
2. 包含匹配：`天衣无缝 (2019)` contains `天衣无缝` → +500
3. 简化匹配：`天衣无缝2019` contains `天衣无缝` → +300
4. 关键词匹配：`天衣无缝` → +100
5. 年份匹配：包含 `2019` → +200
6. **总分：1100分** ✅

### 示例3：部分匹配

**Emby媒体项**：
- name: `少帅传奇`
- year: `2015`

**数据库资源**：
- `少帅 (2015)` - 国产剧

**匹配过程**：
1. 搜索词：`少帅传奇`
2. 简化匹配：`少帅2015` contains `少帅` → +300
3. 关键词匹配：`少帅` → +100
4. 年份匹配：包含 `2015` → +200
5. 分词匹配：`少帅` → +50
6. **总分：650分** ✅

### 示例4：无匹配

**Emby媒体项**：
- name: `权力的游戏`
- year: `2011`

**数据库资源**：
- `韫色过浓 (2020)`
- `天衣无缝 (2019)`
- ...

**匹配过程**：
1. 搜索词：`权力的游戏`
2. 所有资源分数都是 0
3. **结果：未找到匹配** ❌

## 优势

1. **智能评分**：多维度评分，匹配更准确
2. **容错性强**：支持部分匹配、简化匹配
3. **优先级明确**：完全匹配 > 包含匹配 > 关键词匹配
4. **年份加权**：有年份信息时优先匹配
5. **日志详细**：每个匹配步骤都有日志，便于调试

## 调试日志

启用 DEBUG 日志可以看到详细的匹配过程：

```
智能搜索115资源: name=韫色过浓, originalTitle=null, year=2020
搜索关键词: [韫色过浓, 韫色过浓]
数据库中共有 6 个资源
资源 [韫色过浓 (2020)] 匹配分数: 1100
  包含匹配: 韫色过浓 (2020) contains 韫色过浓
  简化匹配: 韫色过浓2020 contains 韫色过浓
  关键词匹配: 1 个关键词
  年份匹配: 2020
最佳匹配: [韫色过浓 (2020)], 分数: 1100
```

## 性能优化

- 一次性加载所有资源到内存（适合资源数量不大的场景）
- 如果资源数量很大（>10000），可以改为分批查询或添加索引

## 扩展建议

1. **相似度算法**：可以引入编辑距离（Levenshtein Distance）算法
2. **拼音匹配**：支持拼音搜索
3. **缓存优化**：缓存搜索结果，提高性能
4. **机器学习**：使用 TF-IDF 或词向量提高匹配准确度

---

**实施日期**: 2026-02-03
**算法版本**: v2.0 (评分匹配)
