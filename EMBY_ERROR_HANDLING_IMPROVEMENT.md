# Emby 缓存数据缺失处理优化

## 问题描述

之前的实现中，当数据库中没有数据时：
- 后端只是返回空列表
- 前端显示"暂无数据"
- 用户不知道是真的没有数据，还是需要先同步

**用户困惑**：看到"暂无数据"，不知道该怎么办。

## 解决方案

### 修改内容

将所有查询方法中的"返回空列表"改为"抛出友好的业务异常"。

### 修改的方法

1. **getAllLibraries()** - 获取媒体库列表
2. **getLibraryItemsPaged()** - 获取媒体库的媒体项
3. **getItemDetail()** - 获取媒体项详情
4. **searchItems()** - 搜索媒体项
5. **getAllGenres()** - 获取类型列表
6. **getAllTags()** - 获取标签列表
7. **getAllStudios()** - 获取工作室列表

### 异常信息

所有异常都包含友好的提示信息：

```
数据库中没有XXX数据，请先点击"同步所有数据"按钮进行同步
```

## 效果对比

### 修改前

**后端日志**：
```
WARN: 数据库中没有媒体库 258 的数据，请先执行同步操作
```

**前端显示**：
```
暂无媒体项数据
[刷新数据] 按钮
```

**用户体验**：❌ 用户不知道为什么没有数据，点刷新也没用

### 修改后

**后端日志**：
```
WARN: 数据库中没有媒体库 258 的数据，请先执行同步操作
```

**前端显示**：
```
❌ 错误提示框
数据库中没有该媒体库的数据，请先点击"同步所有数据"按钮进行同步
```

**用户体验**：✅ 用户清楚知道需要先同步数据

## 异常处理流程

```
用户点击"查看媒体项"
    ↓
后端检查数据库
    ↓
数据不存在？
    ↓ 是
抛出 BusinessException
    ↓
前端捕获异常
    ↓
显示错误提示
    ↓
用户看到明确的提示信息
    ↓
用户点击"同步所有数据"
    ↓
问题解决
```

## 各种场景的提示信息

### 1. 媒体库列表为空

```
数据库中没有媒体库数据，请先点击"同步所有数据"按钮进行同步
```

### 2. 某个媒体库的媒体项为空

```
数据库中没有该媒体库的数据，请先点击"同步所有数据"按钮进行同步
```

### 3. 媒体项详情不存在

```
数据库中没有该媒体项的数据，请先点击"同步所有数据"按钮进行同步
```

### 4. 搜索时数据库为空

```
数据库中没有媒体项数据，请先点击"同步所有数据"按钮进行同步
```

### 5. 类型列表为空

```
数据库中没有类型数据，请先点击"同步所有数据"按钮进行同步
```

### 6. 标签列表为空

```
数据库中没有标签数据，请先点击"同步所有数据"按钮进行同步
```

### 7. 工作室列表为空

```
数据库中没有工作室数据，请先点击"同步所有数据"按钮进行同步
```

## 前端处理

前端的 `try-catch` 会捕获这些异常，并通过 `ElMessage.error()` 显示错误提示：

```javascript
try {
  const res = await getLibraryItemsPaged(libraryId, startIndex, limit)
  // 处理数据
} catch (error) {
  // 显示错误提示
  ElMessage.error('加载失败: ' + error.message)
}
```

用户会看到红色的错误提示框，内容为：

```
加载失败: 数据库中没有该媒体库的数据，请先点击"同步所有数据"按钮进行同步
```

## 优势

✅ **明确的错误提示** - 用户知道问题所在
✅ **清晰的解决方案** - 告诉用户该怎么做
✅ **统一的处理方式** - 所有查询方法都一致
✅ **更好的用户体验** - 不再困惑

## 注意事项

### 1. 同步失败的情况

如果同步过程中某个媒体库失败了，可能会出现：
- 媒体库列表有数据
- 但某个媒体库的媒体项没有数据

**解决方法**：重新点击"同步所有数据"按钮

### 2. 部分同步的情况

如果同步过程中断（如网络问题），可能会出现：
- 部分媒体库有数据
- 部分媒体库没有数据

**解决方法**：重新点击"同步所有数据"按钮（会清空旧数据，重新全量同步）

### 3. 数据库被清空

如果手动清空了数据库，所有查询都会抛出异常。

**解决方法**：点击"同步所有数据"按钮

## 测试场景

### 场景1：首次使用

1. 启动应用，数据库为空
2. 访问 Emby 管理页面
3. 看到红色警告提示
4. 尝试点击"刷新"按钮
5. 看到错误提示："数据库中没有媒体库数据，请先点击..."
6. 点击"同步所有数据"
7. 同步完成，可以正常使用

### 场景2：部分数据缺失

1. 数据库中有媒体库列表
2. 但某个媒体库的媒体项没有同步
3. 点击"查看媒体项"
4. 看到错误提示："数据库中没有该媒体库的数据，请先点击..."
5. 点击"同步所有数据"
6. 同步完成，可以正常查看

### 场景3：数据被清空

1. 点击"清空缓存"按钮
2. 数据库被清空
3. 尝试查看任何数据
4. 都会看到错误提示
5. 点击"同步所有数据"
6. 同步完成，恢复正常

## 相关代码

### 后端异常抛出

```java
if (cacheCount == 0) {
    log.warn("数据库中没有媒体库 {} 的数据，请先执行同步操作", libraryId);
    throw new BusinessException("数据库中没有该媒体库的数据，请先点击\"同步所有数据\"按钮进行同步");
}
```

### 前端异常捕获

```javascript
try {
  const res = await getLibraryItemsPaged(libraryId, startIndex, limit)
  libraryItems.value = res.data.items
  totalCount.value = res.data.totalCount
} catch (error) {
  ElMessage.error('加载媒体项失败: ' + error.message)
}
```

## 总结

通过将"返回空列表"改为"抛出友好异常"，大幅提升了用户体验：

- ✅ 用户不再困惑
- ✅ 错误提示清晰明确
- ✅ 解决方案一目了然
- ✅ 统一的处理方式

---

**修改完成时间**: 2026-02-02
