# Emby 同步逻辑优化说明

## 优化内容

### 问题
之前的同步逻辑中，如果某个媒体库同步失败，整个同步过程会中断，导致后面的媒体库都没有同步。

### 解决方案
改进错误处理，让同步过程更健壮：
- 即使某个媒体库同步失败，也继续同步其他媒体库
- 记录失败的媒体库信息
- 在同步结果中显示成功和失败的统计

## 同步流程

### 完整流程

```
1. 清空所有旧数据
   ↓
2. 同步媒体库列表
   ↓
3. 遍历每个媒体库
   ├─ 媒体库1: 全量同步所有媒体项 ✓
   ├─ 媒体库2: 全量同步所有媒体项 ✓
   ├─ 媒体库3: 全量同步所有媒体项 ✗ (失败，但继续)
   ├─ 媒体库4: 全量同步所有媒体项 ✓
   └─ 媒体库5: 全量同步所有媒体项 ✓
   ↓
4. 同步类型、标签、工作室
   ↓
5. 返回同步结果统计
```

### 单个媒体库同步流程

```
开始同步媒体库 (ID: 258)
   ↓
循环获取数据：
   ├─ 第1批: startIndex=0, limit=100 → 获取100条
   ├─ 第2批: startIndex=100, limit=100 → 获取100条
   ├─ 第3批: startIndex=200, limit=100 → 获取100条
   ├─ ...
   └─ 第N批: startIndex=N*100, limit=100 → 获取50条 (最后一批)
   ↓
全部保存到数据库
   ↓
同步完成，共 N*100+50 个媒体项
```

## 同步结果

### 全部成功

**后端返回**：
```json
{
  "success": true,
  "totalLibraries": 5,
  "successLibraries": 5,
  "failedLibraries": 0,
  "totalItems": 3456,
  "totalGenres": 45,
  "totalTags": 67,
  "totalStudios": 89,
  "duration": "180秒"
}
```

**前端提示**：
```
✓ 同步完成！共 5 个媒体库，3456 个媒体项，耗时 180秒
```

### 部分失败

**后端返回**：
```json
{
  "success": false,
  "totalLibraries": 5,
  "successLibraries": 4,
  "failedLibraries": 1,
  "totalItems": 2800,
  "totalGenres": 45,
  "totalTags": 67,
  "totalStudios": 89,
  "duration": "150秒",
  "failedLibraryNames": ["电影 (ID: 258)"],
  "message": "部分媒体库同步失败，请查看日志"
}
```

**前端提示**：
```
⚠ 同步完成，但有 1 个媒体库失败。
成功: 4 个，媒体项: 2800 个。
失败的媒体库: 电影 (ID: 258)
```

### 完全失败

**后端返回**：
```json
{
  "success": false,
  "error": "连接Emby服务器失败"
}
```

**前端提示**：
```
✗ 同步失败: 连接Emby服务器失败
```

## 日志示例

### 成功的日志

```
========================================
开始一次性全量同步所有Emby数据到数据库
========================================
步骤1: 清空旧数据...
旧数据已清空

步骤2: 同步媒体库列表...
从Emby API获取到 5 个媒体库
媒体库列表已保存到数据库

步骤3: 同步所有媒体库的媒体项...
正在同步媒体库 [1/5]: 电影 (ID: 258)
开始全量同步媒体库 258 的所有媒体项
获取第 1 批数据 (startIndex=0, limit=100)
保存第 1 批数据到数据库，共 100 条
获取第 2 批数据 (startIndex=100, limit=100)
保存第 2 批数据到数据库，共 100 条
...
同步进度: 1234/1234 (100%)
媒体库 258 全量同步完成，共 1234 个媒体项
✓ 媒体库 电影 同步完成，共 1234 个媒体项

正在同步媒体库 [2/5]: 电视剧 (ID: 259)
...
✓ 媒体库 电视剧 同步完成，共 567 个媒体项

...

所有媒体项同步完成，共 3456 个
成功: 5 个媒体库，失败: 0 个媒体库

步骤4: 同步类型、标签、工作室...
同步 45 个类型
同步 67 个标签
同步 89 个工作室

========================================
全量同步完成！
媒体库: 5 个（成功: 5，失败: 0）
媒体项: 3456 个
类型: 45 个
标签: 67 个
工作室: 89 个
耗时: 180 秒
========================================
```

### 部分失败的日志

```
========================================
开始一次性全量同步所有Emby数据到数据库
========================================
步骤1: 清空旧数据...
旧数据已清空

步骤2: 同步媒体库列表...
从Emby API获取到 5 个媒体库
媒体库列表已保存到数据库

步骤3: 同步所有媒体库的媒体项...
正在同步媒体库 [1/5]: 电影 (ID: 258)
开始全量同步媒体库 258 的所有媒体项
获取第 1 批数据 (startIndex=0, limit=100)
同步第 1 批数据时出错: Read timed out
✗ 媒体库 电影 同步失败: Read timed out

正在同步媒体库 [2/5]: 电视剧 (ID: 259)
...
✓ 媒体库 电视剧 同步完成，共 567 个媒体项

...

所有媒体项同步完成，共 2800 个
成功: 4 个媒体库，失败: 1 个媒体库
WARN: 失败的媒体库: 电影 (ID: 258)

步骤4: 同步类型、标签、工作室...
同步 45 个类型
同步 67 个标签
同步 89 个工作室

========================================
全量同步完成！
媒体库: 5 个（成功: 4，失败: 1）
媒体项: 2800 个
类型: 45 个
标签: 67 个
工作室: 89 个
耗时: 150 秒
WARN: 失败的媒体库: 电影 (ID: 258)
========================================
```

## 常见失败原因

### 1. 网络超时
```
Read timed out
```
**解决方法**：
- 增加超时时间配置
- 检查网络连接
- 重新同步

### 2. Emby 服务器响应慢
```
Emby服务器响应超时
```
**解决方法**：
- 在服务器空闲时段同步
- 减少每批获取的数量（从100改为50）
- 重新同步

### 3. 媒体库权限问题
```
Access denied
```
**解决方法**：
- 检查 API Key 权限
- 检查用户权限
- 重新配置认证信息

### 4. 数据库连接问题
```
Database connection timeout
```
**解决方法**：
- 检查数据库连接
- 增加数据库连接池大小
- 重新同步

## 重试策略

### 手动重试
如果同步失败，用户可以：
1. 查看后端日志，找到失败原因
2. 解决问题后，重新点击"同步所有数据"按钮
3. 系统会清空旧数据，重新全量同步

### 自动重试（未来优化）
可以添加自动重试机制：
```java
int maxRetries = 3;
for (int retry = 0; retry < maxRetries; retry++) {
    try {
        syncLibraryItemsAll(library.getId());
        break; // 成功，跳出重试循环
    } catch (Exception e) {
        if (retry == maxRetries - 1) {
            // 最后一次重试也失败，记录失败
            failedLibraries.add(library.getName());
        } else {
            // 等待后重试
            Thread.sleep(5000);
        }
    }
}
```

## 数据完整性保证

### 事务管理
- 整个同步过程使用 `@Transactional` 注解
- 如果发生严重错误，会自动回滚
- 保证数据一致性

### 数据验证
同步完成后，可以验证数据完整性：
```sql
-- 检查媒体库数量
SELECT COUNT(*) FROM emby_library_cache;

-- 检查媒体项数量
SELECT COUNT(*) FROM emby_item_cache;

-- 检查每个媒体库的媒体项数量
SELECT parent_id, COUNT(*)
FROM emby_item_cache
GROUP BY parent_id;
```

## 性能优化

### 1. 批量获取
- 每次获取 100 条数据
- 可以根据网络情况调整

### 2. 批量保存
- 使用 MyBatis Plus 的批量插入
- 减少数据库交互次数

### 3. 并发同步（未来优化）
可以考虑并发同步多个媒体库：
```java
ExecutorService executor = Executors.newFixedThreadPool(3);
List<Future<Integer>> futures = new ArrayList<>();

for (EmbyLibrary library : libraries) {
    Future<Integer> future = executor.submit(() -> {
        return syncLibraryItemsAll(library.getId());
    });
    futures.add(future);
}

// 等待所有任务完成
for (Future<Integer> future : futures) {
    totalItems += future.get();
}
```

## 总结

通过这次优化：

✅ **更健壮** - 单个媒体库失败不影响其他媒体库
✅ **更透明** - 详细的成功/失败统计
✅ **更友好** - 清晰的错误提示和失败信息
✅ **更完整** - 确保所有媒体库都尝试同步

现在点击"同步所有数据"按钮后，系统会尽最大努力同步所有媒体库的所有数据！

---

**优化完成时间**: 2026-02-02
