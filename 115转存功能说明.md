# 115网盘转存功能集成说明

## 功能概述

系统已成功集成115网盘转存功能。当通过TMDB ID在`115_resource`表中找到匹配资源时，系统会自动调用115转存API进行转存。

## 功能特点

1. **优先匹配115资源**: 通过TMDB ID精确匹配115资源库
2. **自动转存**: 找到匹配资源后自动调用115 API转存
3. **配置灵活**: 支持通过前端界面配置115 Cookie和目标文件夹
4. **降级处理**: 如果115资源库没有匹配，自动降级到原有的阿里云盘/天翼云盘逻辑

## 配置步骤

### 1. 获取115 Cookie

1. 打开浏览器，访问 https://115.com
2. 登录你的115账号
3. 按F12打开开发者工具
4. 切换到"Network"(网络)标签
5. 刷新页面
6. 找到任意一个请求，查看Request Headers
7. 复制完整的Cookie值

### 2. 配置115转存

1. 打开前端页面
2. 进入"智能搜索配置"页面
3. 找到"115网盘配置"部分
4. 启用"启用115转存"开关
5. 粘贴115 Cookie
6. 设置目标文件夹ID（0表示根目录）
7. 点击"测试115服务"验证配置
8. 点击页面顶部"保存配置"按钮

### 3. 获取目标文件夹ID（可选）

如果要转存到特定文件夹：

1. 在115网页版打开目标文件夹
2. 查看浏览器地址栏URL
3. URL中的`cid=`后面的数字就是文件夹ID
4. 例如：`https://115.com/?cid=123456789`，文件夹ID就是`123456789`

## 使用方式

### 方式1：通过TMDB ID自动转存

当你的系统搜索资源时：

1. 系统首先通过TMDB ID在`115_resource`表中查找
2. 如果找到匹配的115资源，自动调用115转存API
3. 转存成功后记录到`transfer_history`表
4. 如果没找到，降级使用原有的阿里云盘/天翼云盘逻辑

### 方式2：手动调用API转存

**通过TMDB ID转存**:
```bash
POST /api/115-transfer/by-tmdb-id
Content-Type: application/json

{
  "tmdbId": "12345",
  "targetFolderId": "0"  // 可选
}
```

**直接转存资源**:
```bash
POST /api/115-transfer/transfer
Content-Type: application/json

{
  "name": "电影名称",
  "url": "https://115.com/s/xxxxx",
  "code": "访问码"
}
```

## API接口说明

### 1. 通过TMDB ID转存
- **URL**: `/api/115-transfer/by-tmdb-id`
- **方法**: POST
- **参数**:
  - `tmdbId`: TMDB ID（必需）
  - `targetFolderId`: 目标文件夹ID（可选）
- **返回**: 转存结果

### 2. 直接转存资源
- **URL**: `/api/115-transfer/transfer`
- **方法**: POST
- **参数**: Resource115对象
- **返回**: 转存结果

### 3. 测试Cookie
- **URL**: `/api/115-transfer/test-cookie`
- **方法**: GET
- **返回**: Cookie是否有效

### 4. 获取用户信息
- **URL**: `/api/115-transfer/user-info`
- **方法**: GET
- **返回**: 115用户信息

## 数据库表结构

### 115_resource表
存储115资源信息：
- `id`: 主键
- `name`: 资源名称
- `tmdb_id`: TMDB ID（用于匹配）
- `type`: 资源类型
- `size`: 资源大小
- `url`: 115分享链接
- `code`: 访问码

### smart_search_config表
存储115配置（configType='115_config'）：
```json
{
  "enable115Transfer": true,
  "cookie115": "你的Cookie",
  "targetFolderId115": "0"
}
```

## 配置文件

### application.yml
```yaml
app:
  115:
    cookie: ${115_COOKIE:}  # 115网盘Cookie（从环境变量读取，或直接填写）
    target-folder-id: "0"  # 默认转存目标文件夹ID（0表示根目录）
```

**配置优先级**: 数据库配置 > application.yml配置

## 转存逻辑流程

```
1. 接收转存请求（包含TMDB ID）
   ↓
2. 通过TMDB ID在115_resource表中查找资源
   ↓
3. 找到匹配？
   ├─ 是 → 调用115转存API
   │        ↓
   │     转存成功？
   │     ├─ 是 → 记录转存历史 → 返回成功
   │     └─ 否 → 返回失败原因
   │
   └─ 否 → 降级使用原有逻辑（阿里云盘/天翼云盘）
```

## 注意事项

1. **Cookie有效期**: 115 Cookie会过期，需要定期更新
2. **分享链接格式**: 支持 `https://115.com/s/xxxxx` 格式
3. **访问码**: 如果分享链接需要访问码，必须在数据库中填写
4. **转存限制**: 115网盘可能有转存频率限制，建议适当控制请求频率
5. **文件夹ID**: 确保目标文件夹ID存在且有权限

## 故障排查

### Cookie无效
- 重新获取Cookie并更新配置
- 检查Cookie是否完整复制

### 转存失败
- 检查分享链接是否有效
- 检查访问码是否正确
- 检查目标文件夹ID是否存在
- 查看后端日志获取详细错误信息

### 无法匹配资源
- 检查TMDB ID是否正确
- 检查115_resource表中是否有对应资源
- 尝试手动添加资源到115_resource表

## 文件清单

### 后端文件
- `I115TransferService.java` - 115转存服务接口
- `Transfer115ServiceImpl.java` - 115转存服务实现
- `Transfer115Controller.java` - 115转存控制器
- `SmartSearchConfigServiceImpl.java` - 配置服务（已更新）
- `application.yml` - 配置文件（已更新）

### 前端文件
- `transfer115.js` - 115转存API接口
- `SmartSearchConfig.vue` - 智能搜索配置页面（已更新）

## 后续优化建议

1. **Cookie自动刷新**: 实现Cookie过期自动刷新机制
2. **批量转存**: 支持批量转存多个资源
3. **转存队列**: 实现转存队列，避免频率限制
4. **转存进度**: 实时显示转存进度
5. **错误重试**: 转存失败自动重试机制
