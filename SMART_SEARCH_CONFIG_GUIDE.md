# 智能搜索配置界面使用指南

## 概述

智能搜索配置界面提供了一个可视化的配置管理系统,让您可以轻松配置所有智能搜索相关的功能,包括:
- 搜索服务配置
- 阿里云盘配置
- AI智能筛选配置
- 链接验证配置
- 高级设置
- 评分权重自定义

## 访问配置界面

1. 启动应用后,在左侧导航栏找到 **"智能搜索配置"** 菜单项
2. 点击进入配置页面
3. 所有配置都会自动保存到浏览器的 localStorage 中

## 配置项说明

### 1. 搜索服务配置

配置 Telegram 搜索服务的连接信息。

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 搜索API地址 | Telegram搜索服务的API地址 | `http://104.251.122.51:8095/api/v1` |
| 认证Token | 用于访问搜索API的认证令牌 | Bearer token |
| 请求超时 | API请求的超时时间(毫秒) | 30000 |

**测试连接**: 点击"测试搜索服务"按钮验证配置是否正确。

### 2. 阿里云盘配置

配置资源转存的目标位置。

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 默认目标目录ID | 转存到阿里云盘的默认目录ID | `697f2333cd2704159fa446d8bc5077584838e3dc` |
| 云盘类型 | 选择云盘类型 | 阿里云盘 |

**支持的云盘类型**:
- 阿里云盘 (`channel_alipan`)
- 天翼云盘 (`channel_189`)

**如何获取目录ID**:
1. 登录阿里云盘网页版
2. 进入目标文件夹
3. 查看浏览器地址栏中的 `file_id` 参数

### 3. 链接验证配置

配置搜索结果链接的验证功能。

**验证原理**: 通过实际调用转存API来测试链接是否有效
- ✓ 转存成功 = 链接有效
- ✗ 转存失败/404 = 链接失效
- ? 未验证 = 超出验证数量限制

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 启用链接验证 | 通过实际转存测试验证链接有效性 | 启用 |
| 验证超时 | 单个链接验证的超时时间(毫秒) | 10000 |
| 最大验证数 | 最多验证前N个搜索结果 | 20 |

**验证效果**:
- ✓ 绿色: 链接有效（转存成功）
- ✗ 红色: 链接无效（转存失败或404）
- ? 灰色: 未验证（超出验证数量限制）

**注意事项**:
- 验证过程会实际调用转存API，请确保搜索服务已正确配置
- 建议设置合理的最大验证数，避免过多API调用
- 有效链接会额外获得 +10 分加分

### 4. AI智能筛选配置

配置AI模型用于智能资源筛选。

#### 启用AI筛选
- 开关: 启用/禁用AI智能筛选功能
- 启用后,系统会使用AI模型进行语义匹配,提供更准确的推荐

#### AI提供商选择

**Claude (Anthropic)** - 推荐
- 优点: 高质量输出,理解能力强
- 成本: $3/$15 per 1M tokens
- 获取API Key: [Anthropic Console](https://console.anthropic.com/)
- 推荐模型: Claude 3.5 Sonnet

**OpenAI (GPT)** - 付费
- 优点: 成熟稳定,生态完善
- 成本: $10/$30 per 1M tokens (GPT-4 Turbo)
- 获取API Key: [OpenAI Platform](https://platform.openai.com/api-keys)
- 推荐模型: GPT-4 Turbo

**Ollama (本地)** - 免费
- 优点: 完全免费,数据隐私
- 缺点: 需要本地GPU资源
- 安装: [Ollama官网](https://ollama.com/)
- 推荐模型: Llama 2

#### 模型配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| API Key | AI服务的API密钥(Ollama不需要) | - |
| API地址 | Ollama服务地址 | `http://localhost:11434` |
| 模型选择 | 选择具体的AI模型 | 根据提供商而定 |
| 最大Token数 | AI响应的最大token数量 | 1024 |
| 温度参数 | 控制输出随机性(0-1) | 0.7 |

**温度参数说明**:
- 0: 完全确定性,每次输出相同
- 0.7: 平衡创造性和一致性(推荐)
- 1: 最大创造性,输出更多样化

**测试AI连接**: 点击"测试AI服务"按钮验证AI配置是否正确。

### 5. 高级设置
| 最大结果数 | 每次搜索返回的最大结果数量 | 50 |
| 调试模式 | 启用后在控制台输出详细日志 | 关闭 |
| 自动选择最佳 | 搜索后自动选择评分最高的资源 | 启用 |

**调试模式**: 开发和排查问题时启用,会在浏览器控制台输出详细的评分过程和匹配信息。

### 6. 评分权重配置

自定义智能排序算法的评分权重,总分100分。

| 评分项 | 说明 | 默认权重 | 可调范围 |
|--------|------|----------|----------|
| 标题匹配度 | 标题与电影名称的匹配程度 | 40分 | 0-50分 |
| 分辨率 | 视频分辨率质量(4K/1080p等) | 20分 | 0-30分 |
| 文件大小 | 文件大小合理性 | 15分 | 0-20分 |
| 标签匹配 | 标签与电影类型的匹配 | 10分 | 0-15分 |
| 来源可信度 | 资源来源的可信度 | 10分 | 0-15分 |
| 时效性 | 资源发布时间(越新越好) | 5分 | 0-10分 |

**权重调整建议**:
- **重视画质**: 提���"分辨率"权重到25-30分
- **重视匹配度**: 提高"标题匹配度"权重到45-50分
- **重视新资源**: 提高"时效性"权重到8-10分
- **平衡配置**: 使用默认权重即可

**恢复默认**: 点击"恢复默认权重"按钮重置所有权重。

## 配置管理

### 保存配置
点击页面顶部的 **"保存配置"** 按钮,配置会自动保存到浏览器的 localStorage 中。

### 导出配置
1. 点击 **"导出配置"** 按钮
2. 系统会下载一个 JSON 格式的配置文件
3. 文件名格式: `smart-search-config-{时间戳}.json`

### 导入配置
1. 点击 **"导入配置"** 按钮
2. 选择之前导出的配置文件
3. 系统会自动加载配置并应用

**用途**:
- 在不同浏览器间同步配置
- 备份重要配置
- 分享配置给其他用户

## 使用流程

### 首次配置

1. **配置搜索服务**
   - 确认搜索API地址正确
   - 配置认证Token
   - 点击"测试搜索服务"验证

2. **配置阿里云盘**
   - 设置默认目标目录ID
   - 选择云盘类型

3. **配置链接验证(可选)**
   - 启用链接验证
   - 调整验证超时时间
   - 设置最大验证数量

4. **配置AI筛选(可选)**
   - 选择AI提供商
   - 输入API Key
   - 选择模型
   - 点击"测试AI服务"验证

5. **调整高级设置**
   - 根据需要调整缓存时间
   - 设置最大结果数
   - 启用调试模式(排查问题时)

6. **自定义评分权重(可选)**
   - 根据个人偏好调整权重
   - 确保总分合理

7. **保存配置**
   - 点击"保存配置"按钮

### 日常使用

配置完成后,在 Emby 管理页面使用"搜索下载"功能时,系统会自动应用这些配置:

1. 使用配置的搜索服务进行搜索
2. 根据配置的权重进行智能排序
3. 如果启用，通过实际转存测试验证链接有效性
4. 如果启用，使用AI进行智能推荐
5. 自动选择最佳匹配(如果启用)
6. 转存到搜索服务配置的云盘目录

## 配置示例

### 示例1: 重视画质 + 链接验证

```json
{
  "aiEnabled": true,
  "aiProvider": "claude",
  "validateLinks": true,
  "maxValidationCount": 30,
  "weights": {
    "titleMatch": 35,
    "resolution": 30,
    "fileSize": 15,
    "tagMatch": 10,
    "sourceCredibility": 5,
    "timeliness": 5
  }
}
```

### 示例2: 重视匹配度 + 快速搜索

```json
{
  "aiEnabled": true,
  "aiProvider": "claude",
  "validateLinks": false,
  "weights": {
    "titleMatch": 50,
    "resolution": 20,
    "fileSize": 10,
    "tagMatch": 10,
    "sourceCredibility": 5,
    "timeliness": 5
  }
}
```

### 示例3: 本地AI + 精确验证

```json
{
  "aiEnabled": true,
  "aiProvider": "ollama",
  "aiApiUrl": "http://localhost:11434",
  "aiModel": "llama2",
  "validateLinks": true,
  "maxValidationCount": 10,
  "validationTimeout": 15000,
  "cacheTime": 600,
  "maxResults": 30
}
```

## 故障排查

### 问题1: AI筛选不工作

**检查项**:
1. 确认已启用AI筛选
2. 检查API Key是否正确
3. 点击"测试AI服务"验证连接
4. 查看浏览器控制台是否有错误信息
5. 检查API额度是否充足

**解决方案**:
- 如果API Key错误,重新配置
- 如果额度不足,充值或切换到Ollama
- 如果网络问题,检查代理设置

### 问题2: 链接验证失败或很慢

**检查项**:
1. 确认已启用链接验证
2. 检查搜索服务网络连接
3. 查看验证超时设置

**解决方案**:
- 增加验证超时时间（15000-20000ms）
- 减少最大验证数量（10-15个）
- 暂时禁用链接验证使用规则评分
- 检查搜索服务的转存API是否正常

### 问题3: 搜索结果不理想

**检查项**:
1. 查看评分权重配置
2. 启用调试模式查看评分详情
3. 检查搜索关键词是否正确

**解决方案**:
- 调整评分权重
- 启用AI筛选提高准确度
- 增加最大结果数

### 问题4: 配置丢失

**原因**: 浏览器清除了 localStorage

**解决方案**:
1. 定期导出配置备份
2. 重新配置或导入备份的配置文件

## 性能优化建议

### 1. 缓存配置
- 开发测试: 缓存时间设为 60 秒
- 日常使用: 缓存时间设为 300 秒
- 频繁搜索: 缓存时间设为 600 秒

### 2. 链接验证
- 快速搜索: 禁用链接验证
- 精确搜索: 启用链接验证，最大验证数 10-20
- 大量结果: 减少最大验证数到 5-10，增加超时时间

### 3. AI筛选
- 成本优先: 使用 Ollama 本地模型
- 质量优先: 使用 Claude 3.5 Sonnet
- 平衡选择: 使用 GPT-3.5 Turbo

### 4. 结果数量
- 快速浏览: 最大结果数 20-30
- 详细对比: 最大结果数 50-100
- 性能优先: 最大结果数 10-20

## 安全建议

1. **API Key 保护**
   - 不要分享包含 API Key 的配置文件
   - 定期更换 API Key
   - 使用环境变量存储敏感信息

2. **配置备份**
   - 定期导出配置备份
   - 将备份文件存储在安全位置
   - 不要将备份文件上传到公共位置

3. **权限控制**
   - 确保只有授权用户可以访问配置界面
   - 使用强密码保护管理账户

## 成本估算

### Claude API
- 每次AI筛选: 约 1000 tokens
- 成本: 约 $0.02 / 次
- 月使用 1000 次: 约 $20

### OpenAI GPT-4
- 每次AI筛选: 约 1000 tokens
- 成本: 约 $0.04 / 次
- 月使用 1000 次: 约 $40

### Ollama (本地)
- 完全免费
- 需要 GPU: RTX 3060 或更高
- 电费成本: 可忽略

## 更新日志

### v1.0.0 (2026-02-01)
- ✅ 初始版本发布
- ✅ 支持搜索服务配置
- ✅ 支持阿里云盘配置
- ✅ 支持AI智能筛选配置
- ✅ 支持链接验证配置
- ✅ 支持高级设置
- ✅ 支持评分权重自定义
- ✅ 支持配置导入导出

## 相关文档

- [智能搜索功能指南](./EMBY_SMART_SEARCH_GUIDE.md)
- [AI集成指南](./AI_INTEGRATION_GUIDE.md)
- [Emby集成指南](./EMBY_INTEGRATION_GUIDE.md)

## 技术支持

如有问题或建议,请:
1. 查看本文档的故障排查部分
2. 启用调试模式查看详细日志
3. 查看浏览器控制台错误信息
4. 联系技术支持团队

## 许可证

MIT License
