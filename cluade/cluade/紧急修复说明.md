# 紧急修复：ClassCastException 错误

## 错误信息
```
java.lang.ClassCastException: java.util.LinkedHashMap cannot be cast to com.gdupload.entity.FileInfo
```

## 问题原因

前端发送的 `fileList` 是 JSON 数组，Spring Boot 自动将其反序列化为 `List<LinkedHashMap>`，而不是 `List<FileInfo>`。

直接强制转换会导致 `ClassCastException`。

## 修复方案

### 修改文件：FileController.java

**位置**：`F:\cluade\backend\src\main\java\com\gdupload\controller\FileController.java`

**修改内容**：第 56-85 行

```java
@PostMapping("/batch-save")
public Result<Void> batchSaveFiles(@RequestBody Map<String, Object> params) {
    Long taskId = Long.valueOf(params.get("taskId").toString());
    List<Map<String, Object>> fileListMaps = (List<Map<String, Object>>) params.get("fileList");

    // 转换 Map 为 FileInfo 对象
    List<FileInfo> fileList = fileListMaps.stream().map(map -> {
        FileInfo fileInfo = new FileInfo();
        fileInfo.setFileName((String) map.get("fileName"));
        fileInfo.setFilePath((String) map.get("filePath"));

        // 处理 fileSize，可能是 Integer 或 Long
        Object sizeObj = map.get("fileSize");
        if (sizeObj instanceof Integer) {
            fileInfo.setFileSize(((Integer) sizeObj).longValue());
        } else if (sizeObj instanceof Long) {
            fileInfo.setFileSize((Long) sizeObj);
        } else if (sizeObj != null) {
            fileInfo.setFileSize(Long.valueOf(sizeObj.toString()));
        }

        fileInfo.setStatus(0); // 待上传
        fileInfo.setCreateTime(java.time.LocalDateTime.now());
        return fileInfo;
    }).collect(java.util.stream.Collectors.toList());

    boolean success = fileInfoService.batchSaveFiles(taskId, fileList);

    return success ? Result.success("保存成功") : Result.error("保存失败");
}
```

## 部署步骤

### 1. 重新编译后端

```bash
cd /work/backend
mvn clean package -DskipTests
```

### 2. 停止旧服务

```bash
kill $(cat /work/app.pid)
```

### 3. 部署新版本

```bash
cp target/*.jar /work/gdupload.jar
cd /work
nohup java -Dfile.encoding=UTF-8 -Xms512m -Xmx2048m -jar gdupload.jar > nohup.out 2>&1 &
echo $! > app.pid
```

### 4. 检查日志

```bash
tail -f /work/nohup.out
```

等待看到：
```
Started GdUploadManagerApplication in X.XXX seconds
```

## 验证修复

### 1. 测试扫描功能

1. 访问前端 `http://localhost:3000`
2. 进入"文件上传"页面
3. 输入源路径：`/data`
4. 点击"扫描目录"
5. 应该看到文件列表

### 2. 测试创建任务

1. 选择几个文件
2. 点击"创建任务"
3. 如果文件超过 1000 个，选择"仅上传已选"
4. 确认创建
5. 检查是否成功创建任务

### 3. 检查数据库

```sql
-- 检查任务是否创建
SELECT * FROM upload_task ORDER BY create_time DESC LIMIT 1;

-- 检查文件是否保存
SELECT COUNT(*) FROM file_info WHERE task_id = <刚创建的任务ID>;
```

## 其他可能的问题

### 问题1：上传没有成功

**检查点**：
1. 任务是否启动？查看任务状态
2. 账号是否添加？进入"账号管理"检查
3. Rclone 配置是否正确？

**解决方案**：
```bash
# 检查 rclone 配置
rclone listremotes

# 测试上传
echo "test" > /tmp/test.txt
rclone copy /tmp/test.txt guser01:/test/
```

### 问题2：文件状态一直是"待上传"

**原因**：任务没有启动或账号配额不足

**解决方案**：
1. 在任务管理页面点击"启动"按钮
2. 检查账号配额是否充足
3. 查看后端日志是否有错误

### 问题3：备份目录权限问题

**错误**：`备份文件失败: Permission denied`

**解决方案**：
```bash
# 创建备份目录并设置权限
sudo mkdir -p /backdata
sudo chown -R your_user:your_group /backdata
sudo chmod 755 /backdata
```

## 完整测试流程

### 测试1：少量文件（< 1000）

```bash
# 创建测试目录
mkdir -p /tmp/test_upload
echo "file1" > /tmp/test_upload/file1.txt
echo "file2" > /tmp/test_upload/file2.txt
echo "file3" > /tmp/test_upload/file3.txt
```

1. 扫描 `/tmp/test_upload`
2. 选择所有文件
3. 创建任务
4. 启动任务
5. 检查是否上传成功
6. 检查文件是否备份到 `/backdata/任务名/`
7. 检查源文件是否删除

### 测试2：大量文件（> 1000）

1. 扫描 `/data`（45305 个文件）
2. 看到警告消息
3. 选择前 1000 个文件
4. 创建任务
5. 选择"全部上传"
6. 确认创建
7. 启动任务
8. 观察上传进度

## 预期结果

### 正常流程

1. ✅ 扫描成功，显示文件列表
2. ✅ 创建任务成功
3. ✅ 文件信息保存到数据库
4. ✅ 启动任务成功
5. ✅ 文件逐个上传
6. ✅ 上传成功后备份到 `/backdata/`
7. ✅ 源文件删除
8. ✅ 任务状态更新为"已完成"

### 日志示例

```
2026-01-18 10:00:00.000 [main] INFO  com.gdupload.GdUploadManagerApplication - Started GdUploadManagerApplication in 6.258 seconds
2026-01-18 10:01:00.000 [http-nio-8099-exec-1] INFO  com.gdupload.service.impl.FileInfoServiceImpl - 扫描目录完成: path=/data, fileCount=45305
2026-01-18 10:02:00.000 [http-nio-8099-exec-2] INFO  com.gdupload.service.impl.FileInfoServiceImpl - 批量保存文件信息成功: taskId=1, count=1000
2026-01-18 10:03:00.000 [taskExecutor-1] INFO  com.gdupload.service.impl.UploadServiceImpl - 开始执行上传任务: taskId=1
2026-01-18 10:03:05.000 [taskExecutor-1] INFO  com.gdupload.service.impl.GdAccountServiceImpl - 选择账号: accountName=账号1, remainingQuota=750000000000, requiredSize=1048576
2026-01-18 10:03:10.000 [taskExecutor-1] INFO  com.gdupload.service.impl.UploadServiceImpl - 文件上传成功: taskId=1, fileId=1, fileName=file1.txt, progress=0%
2026-01-18 10:03:11.000 [taskExecutor-1] INFO  com.gdupload.service.impl.UploadServiceImpl - 文件已备份并删除: /data/file1.txt -> /backdata/上传任务_2026-01-18/file1.txt
```

## 如果还有问题

请提供以下信息：

1. **完整的错误日志**：
   ```bash
   tail -100 /work/nohup.out
   ```

2. **数据库状态**：
   ```sql
   SELECT * FROM upload_task ORDER BY id DESC LIMIT 5;
   SELECT * FROM file_info ORDER BY id DESC LIMIT 10;
   SELECT * FROM gd_account;
   ```

3. **前端控制台错误**：
   - 打开浏览器开发者工具
   - 查看 Console 和 Network 标签

4. **操作步骤**：
   - 详细描述你的操作步骤
   - 在哪一步出现问题
