# 前端部署说明

## 方式一：自动部署（推荐）

在本地 Windows 上执行（需要安装 Git Bash）：

```bash
cd F:/cluade
chmod +x deploy-frontend.sh
./deploy-frontend.sh
```

**注意**：需要配置 SSH 免密登录，否则会多次要求输入密码。

---

## 方式二：手动部署

### 步骤 1：本地构建

在本地 Windows 上执行：

```bash
cd F:/cluade/frontend
npm run build
```

构建完成后，会在 `F:/cluade/frontend/dist` 目录生成静态文件。

### 步骤 2：上传到服务器

使用 WinSCP、FileZilla 或命令行上传：

```bash
# 使用 scp 上传（在 Git Bash 中）
cd F:/cluade/frontend
scp -r dist/* root@104.251.122.51:/work/frontend/
```

或者手动压缩后上传：
```bash
cd F:/cluade/frontend/dist
tar -czf frontend.tar.gz .
scp frontend.tar.gz root@104.251.122.51:/work/
```

### 步骤 3：在服务器上配置

SSH 登录到服务器：

```bash
ssh root@104.251.122.51
```

执行以下命令：

```bash
# 创建前端目录
mkdir -p /work/frontend

# 如果上传的是压缩包，解压
cd /work
tar -xzf frontend.tar.gz -C /work/frontend/

# 安装 Nginx（如果未安装）
apt-get update
apt-get install -y nginx

# 创建 Nginx 配置
cat > /etc/nginx/sites-available/gdupload << 'EOF'
server {
    listen 8098;
    server_name _;

    # 前端静态文件
    location / {
        root /work/frontend;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 代理
    location /api/ {
        proxy_pass http://127.0.0.1:8099/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket 代理
    location /ws/ {
        proxy_pass http://127.0.0.1:8099/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
EOF

# 启用配置
ln -sf /etc/nginx/sites-available/gdupload /etc/nginx/sites-enabled/gdupload
rm -f /etc/nginx/sites-enabled/default

# 测试配置
nginx -t

# 重启 Nginx
systemctl restart nginx
systemctl enable nginx

# 检查状态
systemctl status nginx
```

### 步骤 4：验证部署

1. 在浏览器访问：`http://104.251.122.51:8098`
2. 应该能看到前端页面
3. 测试功能是否正常

---

## 方式三：使用 Docker（可选）

如果服务器上有 Docker，可以使用 Nginx 容器：

```bash
# 在服务器上执行
docker run -d \
  --name gdupload-frontend \
  -p 8098:80 \
  -v /work/frontend:/usr/share/nginx/html:ro \
  -v /work/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
  --restart always \
  nginx:alpine
```

需要先创建 `/work/nginx.conf`：

```nginx
server {
    listen 80;
    server_name _;

    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://host.docker.internal:8099/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /ws/ {
        proxy_pass http://host.docker.internal:8099/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

---

## 故障排查

### 1. 无法访问前端

```bash
# 检查 Nginx 状态
systemctl status nginx

# 查看 Nginx 错误日志
tail -50 /var/log/nginx/error.log

# 检查端口是否监听
netstat -tlnp | grep :8098

# 检查防火墙
ufw status
# 如果需要开放 8098 端口
ufw allow 8098
```

### 2. API 请求失败

```bash
# 检查后端服务
ps aux | grep gdupload
tail -50 /work/nohup.out

# 测试后端 API
curl http://127.0.0.1:8099/api/task/page?current=1&size=10
```

### 3. 页面空白

- 检查浏览器控制台是否有错误
- 检查 Nginx 配置中的 root 路径是否正确
- 确认 `/work/frontend/index.html` 文件存在

### 4. 重新部署

如果需要更新前端：

```bash
# 本地重新构建
cd F:/cluade/frontend
npm run build

# 上传到服务器（覆盖旧文件）
scp -r dist/* root@104.251.122.51:/work/frontend/

# 清除浏览器缓存后刷新页面
```

---

## 生产环境优化建议

### 1. 启用 Gzip 压缩

在 Nginx 配置中添加：

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss;
```

### 2. 配置缓存

```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. 配置 HTTPS（推荐）

使用 Let's Encrypt 免费证书：

```bash
apt-get install -y certbot python3-certbot-nginx
certbot --nginx -d yourdomain.com
```

### 4. 配置访问日志

```nginx
access_log /var/log/nginx/gdupload-access.log;
error_log /var/log/nginx/gdupload-error.log;
```
